<?php
$this->htmlElement('body')->appendAttribute('class', 'sync');
$this->headLink()->appendStylesheet($this->assetUrl('css/my-module.css', 'MyModule'));
$this->headScript()->appendFile($this->assetUrl('js/my-module.js', 'MyModule'));
$resourceClasses = $this->vars()->resourceClasses ?? [];
$itemSets = $this->vars()->itemSets ?? [];
$lastSync = $this->vars()->lastSync;
?>

<?php echo $this->pageTitle('Sync to AnythingLLM RAG'); ?>

<div id="page-actions">
    <?php echo $this->hyperlink($this->translate('Back to Admin'), $this->url('admin'), ['class' => 'button']); ?>
</div>

<div class="sync-container">
    <div class="sync-header">
        <h2><?php echo $this->translate('Synchronize Items to AnythingLLM'); ?></h2>
        <p class="explanation">
            <?php echo $this->translate('This will export selected Omeka S items as documents to your AnythingLLM RAG system.'); ?>
            <?php echo $this->translate('Documents will be formatted with [TYPE-ID] prefixes for easy reference linking.'); ?>
        </p>
        <?php if ($lastSync): ?>
            <p class="last-sync">
                <?php echo $this->translate('Last sync:'); ?> 
                <strong><?php echo $this->escapeHtml($lastSync); ?></strong>
            </p>
        <?php endif; ?>
    </div>

    <form method="post" class="sync-form">
        <fieldset>
            <legend><?php echo $this->translate('Resource Types'); ?></legend>
            <div class="field">
                <div class="field-meta">
                    <label><?php echo $this->translate('Select resource types to sync'); ?></label>
                </div>
                <div class="inputs">
                    <div class="option">
                        <label>
                            <input type="checkbox" name="resource_types[]" value="Recipe" checked>
                            <?php echo $this->translate('Recipes'); ?>
                        </label>
                    </div>
                    <div class="option">
                        <label>
                            <input type="checkbox" name="resource_types[]" value="Ingredient">
                            <?php echo $this->translate('Ingredients'); ?>
                        </label>
                    </div>
                    <div class="option">
                        <label>
                            <input type="checkbox" name="resource_types[]" value="User">
                            <?php echo $this->translate('Users'); ?>
                        </label>
                    </div>
                    <div class="option">
                        <label>
                            <input type="checkbox" name="resource_types[]" value="Post">
                            <?php echo $this->translate('Posts'); ?>
                        </label>
                    </div>
                </div>
            </div>
        </fieldset>

        <fieldset>
            <legend><?php echo $this->translate('Item Sets (Optional)'); ?></legend>
            <div class="field">
                <div class="field-meta">
                    <label><?php echo $this->translate('Filter by item sets'); ?></label>
                    <div class="field-description">
                        <?php echo $this->translate('Leave empty to sync all items of selected types'); ?>
                    </div>
                </div>
                <div class="inputs">
                    <?php if (!empty($itemSets)): ?>
                        <?php foreach ($itemSets as $itemSet): ?>
                            <div class="option">
                                <label>
                                    <input type="checkbox" name="item_sets[]" value="<?php echo $itemSet->id(); ?>">
                                    <?php echo $itemSet->displayTitle(); ?>
                                </label>
                            </div>
                        <?php endforeach; ?>
                    <?php else: ?>
                        <p class="explanation"><?php echo $this->translate('No item sets available'); ?></p>
                    <?php endif; ?>
                </div>
            </div>
        </fieldset>

        <fieldset>
            <legend><?php echo $this->translate('Sync Options'); ?></legend>
            
            <div class="field">
                <div class="field-meta">
                    <label><?php echo $this->translate('Full Sync'); ?></label>
                    <div class="field-description">
                        <?php echo $this->translate('Re-sync all items, even if they were previously synced'); ?>
                    </div>
                </div>
                <div class="inputs">
                    <label>
                        <input type="checkbox" name="full_sync" value="1">
                        <?php echo $this->translate('Perform full sync (slower but ensures consistency)'); ?>
                    </label>
                </div>
            </div>

            <div class="field">
                <div class="field-meta">
                    <label><?php echo $this->translate('Batch Size'); ?></label>
                    <div class="field-description">
                        <?php echo $this->translate('Number of items to process in each batch'); ?>
                    </div>
                </div>
                <div class="inputs">
                    <input type="number" name="batch_size" value="50" min="1" max="500">
                </div>
            </div>
        </fieldset>

        <div class="field">
            <input type="submit" value="<?php echo $this->translate('Start Sync Job'); ?>" class="button">
        </div>
    </form>

    <div class="sync-info">
        <h3><?php echo $this->translate('Document Format Information'); ?></h3>
        <div class="info-box">
            <h4><?php echo $this->translate('Enhanced Title Format'); ?></h4>
            <p><?php echo $this->translate('Documents are created with ID-enhanced titles for easy reference:'); ?></p>
            <ul>
                <li><strong>[RECIPE-123]</strong> Chocolate Cake</li>
                <li><strong>[INGREDIENT-45]</strong> Flour</li>
                <li><strong>[USER-7]</strong> John Doe</li>
            </ul>
        </div>

        <div class="info-box">
            <h4><?php echo $this->translate('Reference Headers'); ?></h4>
            <p><?php echo $this->translate('Each document includes metadata headers:'); ?></p>
            <pre>---
<strong>REFERENCE:</strong> RECIPE-123
<strong>TYPE:</strong> Recipe
<strong>OMEKA ID:</strong> 123
<strong>URL:</strong> http://localhost/omeka-s/api/items/123
---</pre>
        </div>

        <div class="info-box">
            <h4><?php echo $this->translate('Using References in Your Application'); ?></h4>
            <p><?php echo $this->translate('When AnythingLLM responds with references like "RECIPE-123", you can:'); ?></p>
            <ul>
                <li>Parse the reference ID from the response</li>
                <li>Extract the type and numeric ID</li>
                <li>Create clickable links back to Omeka items</li>
                <li>Display related content dynamically</li>
            </ul>
            <p class="explanation">
                <?php echo $this->translate('Example: Extract references with regex pattern'); ?> 
                <code>\b[A-Z]+-\d+\b</code>
            </p>
        </div>
    </div>
</div>

<style>
.sync-container {
    max-width: 900px;
}

.sync-header {
    margin-bottom: 2rem;
    padding: 1.5rem;
    background: #f8f9fa;
    border-left: 4px solid #007bff;
    border-radius: 4px;
}

.sync-header h2 {
    margin-top: 0;
    color: #007bff;
}

.sync-header .explanation {
    color: #6c757d;
    margin: 0.5rem 0;
}

.sync-header .last-sync {
    margin: 1rem 0 0;
    padding-top: 1rem;
    border-top: 1px solid #dee2e6;
    color: #6c757d;
}

.sync-form {
    background: white;
    padding: 2rem;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    margin-bottom: 2rem;
}

.sync-form fieldset {
    margin-bottom: 2rem;
    padding: 1.5rem;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
}

.sync-form legend {
    font-weight: bold;
    color: #007bff;
    padding: 0 0.5rem;
}

.sync-form .option {
    margin: 0.5rem 0;
}

.sync-form .option label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.sync-info {
    margin-top: 2rem;
}

.sync-info h3 {
    color: #007bff;
    margin-bottom: 1rem;
}

.info-box {
    background: white;
    padding: 1.5rem;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    margin-bottom: 1rem;
}

.info-box h4 {
    margin-top: 0;
    color: #495057;
}

.info-box pre {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 4px;
    overflow-x: auto;
}

.info-box ul {
    margin: 0.5rem 0;
}

.info-box code {
    background: #f8f9fa;
    padding: 0.2rem 0.4rem;
    border-radius: 3px;
    font-family: monospace;
}
</style>
